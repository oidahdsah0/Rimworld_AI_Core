# P11.6 实施计划：编排服务重构与提示词服务合并（首版即干净）

> 状态：Living Document（实施中持续回填 Gate 勾选与录屏链接）

> 宗旨：无需兼容旧版本，必须删除冗余与兼容层；明确职责边界；以“显式模式 + 工具仅编排 + 统一提示词服务”的最小清晰架构交付。Chat/Stage/Debug 等终端统一使用“组织者 → 组装器 → 终端发起 LLM/写历史”的闭环；编排仅负责工具链执行与结果返回。

---

## 0. 背景与目标

- 现状（P12 之前）
  - Orchestration 层仍保留历史遗留的入口与若干“自动选择/降级链（Auto）”的逻辑，导致一致性问题。
  - 工具匹配模式（Classic/FastTop1/NarrowTopK/LightningFast）逻辑集中于单体服务内部，不利于测试与扩展。
  - 提示词组装（Assembly）和模板（Template/Composer）分散于 Orchestration/Prompting 两处，理解与维护成本高。
  - 设置面板含部分过时项（如 Auto 说明与降级链相关描述）。

- 目标（本计划完成后）
  - 编排服务成为唯一的“工具链入口”，仅负责“调用 → 执行 → 返回 ToolCallsResult”，不触达 LLM，不做自动判断或降级。
  - 四种匹配模式（Classic/LightningFast/FastTop1/NarrowTopK）独立文件实现、统一接口、可被 Planner 显式调用。
  - 完全移除 Auto 模式与相关代码/配置/UI 文案。
  - 合并“提示词组装 + 模板/Composer”为 `Modules/Prompt/` 独立部门目录的单一服务，抽离出 Orchestration 目录。
  - 设置面板清理过时项，仅保留现行逻辑消费的选项。
  - 不保留旧版兼容路径，首版即干净。

---

## 1. 范围与非目标

- 范围：
  - Orchestration 入口重定义（统一入口，显式模式，工具仅编排）。
  - 模式实现拆分为独立文件与统一接口，新增解析器/注册。
  - 删除 Auto 模式及其所有痕迹（Contracts/Source/UI/docs）。
  - 提示词服务合并与目录迁移（`Modules/Prompt/`），更新所有引用。
  - 设置面板删改过时项（含 Auto 文案、无消费项）。
  - 文档/CI grep Gate/样例与录屏更新。

- 非目标：
  - 不引入新的复杂策略/规划算法；Planner 仅获得“可显式选择模式调用”的能力。
  - 不调整历史/持久化模型（继续“仅最终输出”）。

---

## 2. 设计决策与接口契约

### 2.1 Orchestration 统一入口（工具仅编排）

- 替换旧接口：删除 `IOrchestrationService.ExecuteToolAssistedQueryAsync(...)`（流式增量输出）
- 新接口（建议合并现有 IToolOrchestrationService 能力至 IOrchestrationService）
  - `Task<ToolCallsResult> ExecuteAsync(string userInput, IReadOnlyList<string> participantIds, string mode, ToolOrchestrationOptions options = null, CancellationToken ct = default)`
  - 语义：显式 `mode` 选择，仅返回结构化的工具调用结果，不做自然语言汇总，不触达 LLM。
  - 调用方（UI/Stage/Debug/Planner）必须明确传入模式（Classic/FastTop1/NarrowTopK/LightningFast）。

### 2.2 模式拆分与统一标准

- 新增接口 `IToolMatchMode`：
  - `Task<ToolCallsResult> ExecuteAsync(string userInput, IReadOnlyList<string> participantIds, ToolOrchestrationOptions options, CancellationToken ct)`
- 四种实现（独立文件，统一目录 `Modules/Orchestration/Modes/`）：
  - `ClassicMode.cs`
  - `FastTop1Mode.cs`
  - `NarrowTopKMode.cs`
  - `LightningFastMode.cs`
- 新增 `ToolMatchModeResolver`（string→`IToolMatchMode`），由 DI 注入。
- Planner 可注入 `IOrchestrationService` 或 `ToolMatchModeResolver`，以显式模式执行。

### 2.3 移除 Auto 模式

- 删除 Contracts 与实现中的 Auto 文案、分支与参数说明。
- 编排服务不再包含任何“自动选择/降级链”；是否“降级”由调用方自己决定（调用何种模式即是选择）。

### 2.4 提示词服务合并与目录剥离

- 新建部门目录：`RimAI.Core/Source/Modules/Prompt/`
- 新接口 `IPromptService`（统一替代 `IPromptAssemblyService` 与 `IPromptTemplateService` 与 `IPromptComposer`）：
  - `Task<string> ComposeSystemPromptAsync(PromptAssemblyInput input, CancellationToken ct = default)`
  - 可选：`string ResolveLocale()`/`Template GetTemplate(string key)`（内部使用）
- 实现 `PromptService.cs`：合并现有组装/模板/Composer 逻辑；保留段顺序与审计。
- `PromptAssemblyModels.cs` 迁移至 `Modules/Prompt/` 目录。
- 删除原 `Modules/Orchestration/PromptAssemblyService.cs` 与 `Modules/Prompting/*`；更新引用。

### 2.5 设置面板清理

- 移除 Auto 选项；更新说明文案（仅四模式）。
- 移除未被消费的旧项；保留“索引状态/重建”“阈值/权重”“TopK”等仍被使用的项。

---

## 3. 目录与文件变更

```
RimAI.Core/Source/Modules/
  Orchestration/
    Modes/                      ← 新增（四模式独立实现 + 解析器）
    Planning/                   ← 保留；可注入 Resolver/OrchestrationService
    OrchestrationService.cs     ← 重写为统一入口（工具仅编排，显式 mode）

  Prompt/                       ← 新增部门目录
    PromptService.cs            ← 新实现（合并 Assembly + Template/Composer）
    PromptAssemblyModels.cs     ← 迁移自 Orchestration/

  Prompting/                    ← 删除（被 PromptService 吸收）

Source/UI/Settings/Parts/
  Section_ToolMode.cs           ← 移除 Auto 选项与文案
  Section_*                     ← 清理未被消费的过时项
```

---

## 4. 施工路线（分批次）

> 每批均需：编译通过、运行自测、更新 Gate 勾选。若无阻塞，优先并行推进“只读改造 + 代码移动”的批。

### 批次 A：统一编排入口（工具仅编排 + 显式模式）

- 契约：
  - 删除 `IOrchestrationService.ExecuteToolAssistedQueryAsync(...)` 与相关流式类型（如 `UnifiedChatChunk` 在该接口上下文中的使用）。
  - 将 `IToolOrchestrationService.ExecuteAsync(...)` 能力合并进 `IOrchestrationService.ExecuteAsync(...)`（见 2.1）。
- 实现：
  - 重写 `OrchestrationService.cs` 为薄入口：解析 `mode` → 委托给 `ToolMatchModeResolver` 执行 → 返回 `ToolCallsResult`。
  - 移除 Orchestration 目录内所有 `ILLMService` 引用。
- 注册：
  - `ServiceContainer` 仅注册 `IOrchestrationService -> OrchestrationService`。
  - 移除 `IToolOrchestrationService` 注册（如存在则删除接口与实现）。
- Gate：
  - grep=0：`ExecuteToolAssistedQueryAsync|UnifiedChatChunk`；Orchestration 目录 grep=0：`ILLMService|GetResponseAsync|StreamResponseAsync`。

### 批次 B：模式拆分（四模式独立文件 + 解析器）

- 新增接口：`IToolMatchMode`（统一签名）。
- 新增实现：`ClassicMode.cs`、`FastTop1Mode.cs`、`NarrowTopKMode.cs`、`LightningFastMode.cs`（各自内聚匹配/阈值/搜索逻辑）。
- 新增 `ToolMatchModeResolver`：维护 `Dictionary<string, IToolMatchMode>`，区分大小写无关；缺省抛出 `ArgumentException`。
- 注册：
  - `ServiceContainer` 注册四模式与 Resolver。
- Planner 对接：
  - 允许 Planner 注入 Resolver/OrchestrationService，显式传入模式执行。
- Gate：
  - 四模式单元测试覆盖阈值/TopK/无索引场景；无任何“Auto”分支。

### 批次 C：彻底移除 Auto

- 删除代码：
  - 全仓移除/重写 Auto 分支与常量；`ToolOrchestrationOptions.PreferredMode` 注释更新，去除 Auto。
- 配置/默认值：
  - 若 `CoreConfig.Embedding.Tools.Mode` 默认值为 `Auto`，改为 `Classic` 或空（仅作为 UI 默认）。
  - 编排执行一律以入参 `mode` 为准。
- UI：
  - `Section_ToolMode.cs` 删除 Auto 文案与单选项，仅保留四模式；说明文案同步。
- Gate：
  - grep=0：`\bAuto\b`（Contracts/Source/UI/docs）。

### 批次 D：提示词服务合并与目录剥离

- 新建 `Modules/Prompt/` 与 `IPromptService`、`PromptService.cs`。
- 迁移 `PromptAssemblyModels.cs` 至 `Modules/Prompt/`。
- 删除 `Modules/Orchestration/PromptAssemblyService.cs` 与 `Modules/Prompting/*`。
- 替换引用：
  - 组织者（`PromptOrganizers/*`）、Debug（`PromptAuditTestButton.cs`）、UI（`MainTabWindow_Chat.Actions.cs`）、Stage（`GroupChatAct.cs`）全部改为 `IPromptService`。
- DI：
  - `ServiceContainer` 注册 `IPromptService -> PromptService`；移除 `IPromptAssemblyService`/`IPromptTemplateService`/`IPromptComposer` 注册。
- Gate：
  - grep=0：`IPromptAssemblyService|IPromptTemplateService|IPromptComposer`；Prompt 审计功能可用并显示段统计。

### 批次 E：设置面板清理

- 必清：
  - `Section_ToolMode.cs` 移除 Auto；说明文本更新。
- 建议整合/删除（以实际消费为准）：
  - `Section_ProgressTemplates.cs`：如为策略层旧展示且无消费，删除或并入日志配置。
  - `Section_IndexManager.cs`：保留索引重建/状态，去除与降级链相关项。
  - `Section_Prompt.cs`：移除“旧 PromptAssemblyMode/旧模板键”等遗留项，仅保留模板键/预算相关。
- Gate：
  - 设置面板运行不报错；保存后行为稳定；无“幽灵开关”。

### 批次 F：终端（Debug/UI/Stage）对齐

- Debug：
  - 工具测试按钮：改为 `IOrchestrationService.ExecuteAsync(..., mode: "Classic|FastTop1|...")`，展示 `ToolCallsResult`。
  - Prompt 审计按钮：改用 `IPromptService.ComposeSystemPromptAsync`。
- UI：
  - `MainTabWindow_Chat.Actions.cs` 命令分支：显式传 `mode` 调用编排入口，不依赖配置的自动选择。
- Stage：
  - `GroupChatAct.cs` 若需工具链，显式传 `mode`；失败/超时处理与 P11/P12 定义一致（无重试、无历史、`...` 气泡、Warn）。
- Gate：
  - 录屏：四模式各跑一轮工具测试；Chat/Stage 流程不受 Auto 移除影响；Prompt 审计正常。

### 批次 G：文档、CI Gate 与测试

- 文档：
  - 更新 `docs/ARCHITECTURE_V4.md`、`docs/P12_IMPLEMENTATION_PLAN.md` 中关于 Auto/编排入口/提示词服务目录的描述。
- CI/grep Gate：
  - 全仓 grep=0：`\bAuto\b|IPromptAssemblyService|IPromptTemplateService|IPromptComposer|ExecuteToolAssistedQueryAsync|UnifiedChatChunk`
  - Orchestration 目录不含 `ILLMService`。
- 测试：
  - 模式单测：Classic/FastTop1/NarrowTopK/LightningFast（阈值、TopK、无索引）。
  - 端到端：Chat-命令（四模式）、Chat-闲聊（不受影响）、Stage-群聊（如走工具）。
  - Prompt 快照：`PromptContext → PromptAssemblyInput → Compose` 输出 Hash 稳定。

---

## 5. 验收标准（必须全绿）

1) 合规性
- grep 为 0：`\bAuto\b`、`IPromptAssemblyService|IPromptTemplateService|IPromptComposer|ExecuteToolAssistedQueryAsync|UnifiedChatChunk`
- Orchestration 目录不含 `ILLMService` 引用。

2) 功能
- 编排统一入口可按显式模式返回结构化 `ToolCallsResult`。
- 四模式可独立执行并通过单测；Planner 可显式选择模式调用。
- Prompt 审计显示段顺序/字数/裁剪比/总长，目录迁移后功能正常。
- 设置面板无过时项与死链。

3) 体验
- Debug 工具测试与审计按新入口工作。
- Chat/Stage 三链路与 P11/P12 的“终端写最终输出”规则一致且稳定。

4) 性能与稳定性
- 组装 < 2ms/次；每帧新增 ≤ 1ms；无 UI 抖动。
- 无编译告警与 linter 新增问题。

---

## 6. 自测与回归

- 单元测试：
  - 四模式（阈值变化、TopK、索引构建阻断、无索引回退 Classic）。
  - PromptService 组装顺序/预算/裁剪审计。
- 快照测试：
  - `PromptContext → PromptAssemblyInput → ComposeSystemPromptAsync` Hash 稳定（黄金样例）。
- 集成测试：
  - Chat-命令（四模式）：显示工具结果→总结→历史仅写最终输出。
  - Stage 群聊：正常/失败/超时回合（无重试、`...` 气泡、无历史、Warn 日志）。

---

## 7. 风险与缓解

- 外部依赖 `IOrchestrationService` 旧流式接口：以 PR 说明与示例代码引导改造到新入口；Debug 面板示例可作为上手样例。
- Auto 移除导致配置迁移：UI 仅保留四模式；默认值说明在设置面板提示，调用方必须显式传入模式。
- 代码移动造成命名空间引用失败：以批次 D 的“引用替换清单”为准做一次性替换，CI grep Gate 保驾护航。

---

## 8. 提交与代码审查清单（Reviewer 勾选）

- [ ] 删除旧流式入口与类型（grep 为 0）。
- [ ] 新 `IOrchestrationService.ExecuteAsync(...)` 统一入口可用；`IToolOrchestrationService` 已合并/删除。
- [ ] 四模式独立文件 + 解析器 + 注册；单测覆盖。
- [ ] 全仓无 Auto；设置面板无 Auto 文案。
- [ ] 新 `IPromptService` 生效，旧 Prompt 接口/实现已删除；所有调用点已更新。
- [ ] Orchestration 目录无 `ILLMService` 引用。
- [ ] Debug 工具测试/Prompt 审计按新入口工作。
- [ ] CI 绿、grep Gate 绿、黄金样例稳定。

---

## 9. 附录：文件级任务清单（速查）

### 9.1 合同层（Contracts）
- 删除：
  - `RimAI.Core.Contracts/IOrchestrationService.ExecuteToolAssistedQueryAsync(...)`
  - `RimAI.Core.Contracts/Orchestration/IToolOrchestrationService.cs`（如合并至 IOrchestrationService）
- 新增/替换：
  - `IOrchestrationService.ExecuteAsync(string userInput, IReadOnlyList<string> participantIds, string mode, ToolOrchestrationOptions options = null, CancellationToken ct = default)`
  - 更新 `ToolOrchestrationOptions` 注释（去 Auto）。

### 9.2 编排层（Source/Modules/Orchestration）
- 重写：`OrchestrationService.cs`（统一入口）。
- 新增：`Modes/{Classic|FastTop1|NarrowTopK|LightningFast}Mode.cs`、`ToolMatchModeResolver.cs`。
- Planner：支持注入 Resolver/Service 显式模式调用。
- 删除：任何 `ILLMService` 引用与旧策略分支。

### 9.3 提示词服务（Source/Modules/Prompt）
- 新增：`IPromptService.cs`、`PromptService.cs`、迁移 `PromptAssemblyModels.cs`。
- 删除：`Modules/Orchestration/PromptAssemblyService.cs`、`Modules/Prompting/*`。
- 更新引用：Organizer/UI/Stage/Debug 全量替换为 `IPromptService`。

### 9.4 设置与 UI（Source/UI/Settings/Parts）
- 修改：`Section_ToolMode.cs`（移除 Auto）。
- 清理：`Section_ProgressTemplates.cs`、`Section_IndexManager.cs`、`Section_Prompt.cs` 中未消费项。

### 9.5 Debug 与终端
- Debug：工具测试改调新编排入口；Prompt 审计改调 `IPromptService`。
- UI/Stage：命令/Act 显式传入模式；其余逻辑不变（LLM 与历史由终端负责）。

---

> 说明：本计划为“首版即干净”的破坏性改造，不保留兼容路径；建议以“批次粒度”提交 PR（每批≤600 行），并附录屏与 Gate 勾选，便于回滚与复核。


