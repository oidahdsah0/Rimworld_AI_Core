# TODO - 2025-07-23: å®ç°AIå·¥å…·è°ƒç”¨åŠŸèƒ½ (Function Calling)

## ğŸ¯ æœ€ç»ˆç›®æ ‡ (Goal)

æˆ‘ä»¬è®¡åˆ’å¯¹ `Governor` æœåŠ¡è¿›è¡Œä¸€æ¬¡é‡å¤§å‡çº§ï¼Œä»å½“å‰çš„â€œå“åº”å¼â€AIè½¬å˜ä¸ºâ€œä¸»åŠ¨å¼â€AIã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°ä¸€ä¸ª **Function Calling** æˆ– **Tool Use** çš„å·¥ä½œæµï¼šè®©AIä¸å†æ˜¯æœºæ¢°åœ°ä½¿ç”¨å•ä¸€æ¨¡æ¿è¿›è¡Œå›å¤ï¼Œè€Œæ˜¯èƒ½**æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼Œè‡ªä¸»å†³ç­–åº”è¯¥è°ƒç”¨å“ªä¸ªå†…éƒ¨åŠŸèƒ½ï¼ˆæˆ–ä½¿ç”¨å“ªä¸ªæç¤ºè¯æ¨¡æ¿ï¼‰**ã€‚

è¿™ä¸ªæ–°æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š
1.  **åˆ†æ´¾ (Dispatch)**: å‘AIæä¾›ä¸€ä¸ªâ€œå·¥å…·æ¸…å•â€å’Œç”¨æˆ·è¾“å…¥ï¼Œè®©AIä»¥ç»“æ„åŒ–çš„æ ¼å¼ï¼ˆå¦‚JSONï¼‰è¿”å›å®ƒé€‰æ‹©çš„å·¥å…·åŠæ‰€éœ€å‚æ•°ã€‚
2.  **æ‰§è¡Œ (Execute)**: C#ä»£ç è§£æAIçš„å†³ç­–ï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„å†…éƒ¨æ–¹æ³•ï¼ˆå¦‚ `HandleUserQueryAsync` æˆ– `HandlePawnInfoQueryAsync`ï¼‰ï¼Œå¹¶å°†æœ€ç»ˆç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

## ğŸŒŠ å·¥ä½œæµå›¾ç¤º (Workflow Diagram)

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Governor as æ€»ç£ (Governor)
    participant LLMService as LLMæœåŠ¡
    participant ColonyAnalyzer as æ®–æ°‘åœ°åˆ†æå™¨ (C#)

    User->>Governor: å‘å‡ºæŒ‡ä»¤ (e.g., "æ®–æ°‘åœ°å¿ƒæƒ…å¦‚ä½•ï¼Ÿ")
    Governor->>LLMService: <b>å†³ç­–è¯·æ±‚ (Step 1)</b><br/>"è¯¥ç”¨å“ªä¸ªå·¥å…·åˆ†æ'æ®–æ°‘åœ°å¿ƒæƒ…'ï¼Ÿ"<br/>é™„å¸¦å·¥å…·åˆ—è¡¨: [analyzeColonyMood, ...]
    LLMService-->>Governor: è¿”å›å†³ç­– (JSON)<br/>{ "tool_to_call": "analyzeColonyMood" }
    Governor->>ColonyAnalyzer: <b>æ‰§è¡Œå·¥å…· (Step 2.1)</b><br/>è°ƒç”¨ C# æ–¹æ³• analyzeColonyMood()
    ColonyAnalyzer-->>Governor: è¿”å›å®æ—¶æ•°æ®<br/>"å¿ƒæƒ…ä½è½ï¼Œç¼ºå°‘å¨±ä¹..."
    Governor->>LLMService: <b>ç”Ÿæˆå›å¤è¯·æ±‚ (Step 2.2)</b><br/>"æ ¹æ®'å¿ƒæƒ…ä½è½'çš„æ•°æ®ï¼Œç»™ç©å®¶ä¸€äº›å»ºè®®"
    LLMService-->>Governor: è¿”å›æœ€ç»ˆå›å¤æ–‡æœ¬<br/>"æŒ‡æŒ¥å®˜ï¼Œå¤§å®¶å¿ƒæƒ…ä¸å¤ªå¥½ï¼Œä¹Ÿè®¸å¯ä»¥é€ ä¸ªæ£‹ç›˜ï¼Ÿ"
    Governor->>User: æ˜¾ç¤ºæœ€ç»ˆå›å¤
```

## ğŸš€ æ¶æ„è®¾è®¡ï¼šå¯æ’æ‹”çš„è°ƒåº¦å™¨ (Architecture Design: Pluggable Dispatcher)

ä¸ºäº†æ»¡è¶³åŠŸèƒ½éœ€åŒæ—¶å…¼å®¹ `Function Calling` å’Œ `JSON` æ¨¡å¼ï¼Œå¹¶ä¸ºæœªæ¥çš„ `Embedding` æœ¬åœ°åŒ–æ–¹æ¡ˆé¢„ç•™æ‰©å±•ç©ºé—´ï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨**ç­–ç•¥æ¨¡å¼ (Strategy Pattern)** æ¥æ„å»ºæ ¸å¿ƒçš„å·¥å…·è°ƒåº¦åŠŸèƒ½ã€‚

è¿™å°†å…è®¸æˆ‘ä»¬å®šä¹‰ä¸€ç³»åˆ—å¯äº’æ¢çš„ç®—æ³•ï¼ˆç­–ç•¥ï¼‰ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æ ¹æ®ç”¨æˆ·åœ¨è®¾ç½®ä¸­çš„é€‰æ‹©ï¼ŒåŠ¨æ€åˆ‡æ¢ä½¿ç”¨å“ªä¸€ç§ã€‚

### æ ¸å¿ƒæ­¥éª¤

1.  **å®šä¹‰æ ¸å¿ƒæ¥å£å’Œæ¨¡å‹ (`IDispatcherService`, `ToolModels.cs`)**:
    *   åˆ›å»º `IDispatcherService` æ¥å£ï¼Œå®šä¹‰æ‰€æœ‰è°ƒåº¦ç­–ç•¥éƒ½å¿…é¡»éµå®ˆçš„å¥‘çº¦ï¼ˆä¾‹å¦‚ `DispatchAsync` æ–¹æ³•ï¼‰ã€‚
    *   åˆ›å»º `ToolModels.cs` ç­‰æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰ `AITool` ç­‰ä¸AIå·¥å…·è°ƒç”¨ç›¸å…³çš„æ ‡å‡†åŒ–æ•°æ®ç»“æ„ã€‚

2.  **åˆ›å»ºå…·ä½“ç­–ç•¥å®ç° (`*DispatcherService.cs`)**:
    *   `LlmToolDispatcherService`: å®ç° `IDispatcherService` æ¥å£ï¼Œå†…éƒ¨é€»è¾‘ä½¿ç”¨ `LLMService` çš„ `WithTools()` æ–¹æ³•ï¼Œé€šè¿‡ `Function Calling` API å®Œæˆå·¥å…·é€‰æ‹©ã€‚
    *   `LlmJsonDispatcherService`: å®ç° `IDispatcherService` æ¥å£ï¼Œå†…éƒ¨é€»è¾‘ä½¿ç”¨ `WithJsonOutput()`ï¼Œé€šè¿‡ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿæç¤ºè¯æ¥å¼•å¯¼LLMè¿”å›æŒ‡å®šæ ¼å¼çš„JSONï¼Œä»è€Œå®Œæˆå·¥å…·é€‰æ‹©ã€‚
    *   `EmbeddingDispatcherService`: é¢„ç•™çš„ç©ºå®ç°ï¼Œä¸ºæœªæ¥é€šè¿‡æœ¬åœ°å‘é‡åŒ¹é…é€‰æ‹©å·¥å…·çš„åŠŸèƒ½å ä½ã€‚

3.  **åˆ›å»ºè°ƒåº¦å™¨å·¥å‚ (`DispatcherFactory.cs`)**:
    *   åˆ›å»ºä¸€ä¸ªé™æ€å·¥å‚ï¼Œå®ƒä¼šè¯»å– `CoreSettings` ä¸­çš„ç”¨æˆ·é…ç½®ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„ `IDispatcherService` å®ä¾‹ã€‚è¿™æ˜¯å®ç°åŠ¨æ€åˆ‡æ¢çš„å…³é”®ã€‚

4.  **æ›´æ–°è®¾ç½® (`CoreSettings.cs` & `CoreSettingsWindow.cs`)**:
    *   åœ¨ `CoreSettings.cs` ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ `enum` (ä¾‹å¦‚ `DispatchMode`)ï¼ŒåŒ…å« `LlmTool`, `LlmJson`, `LocalEmbedding` ç­‰é€‰é¡¹ã€‚
    *   åœ¨ `CoreSettingsWindow.cs` ä¸­æ·»åŠ å¯¹åº”çš„UIæ§ä»¶ï¼Œè®©ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œé€‰æ‹©ã€‚

5.  **æ”¹é€ æ€»ç£ (`Governor.cs`)**:
    *   é‡æ„ `Governor` çš„æ ¸å¿ƒå†³ç­–é€»è¾‘ã€‚å®ƒå°†ä¸å†å…³å¿ƒå¦‚ä½•é€‰æ‹©å·¥å…·ï¼Œè€Œæ˜¯å®Œå…¨å§”æ‰˜ç»™è°ƒåº¦å™¨ã€‚
    *   æµç¨‹å˜ä¸ºï¼šé€šè¿‡ `DispatcherFactory` è·å–å½“å‰ç­–ç•¥ -> è°ƒç”¨ç­–ç•¥çš„ `DispatchAsync` æ–¹æ³•è·å–å†³ç­– -> æ‰§è¡Œå†³ç­–ã€‚

### æ¶æ„å›¾ç¤º

```mermaid
graph TD
    subgraph "Rimworld_AI_Core"
        direction TB
        
        Governor("<b>Governor.cs</b><br>1. è¯·æ±‚å†³ç­–")
        Factory("<b>DispatcherFactory.cs</b><br>2. æ ¹æ®è®¾ç½®åˆ›å»ºç­–ç•¥")
        Settings("CoreSettings<br>ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼")

        subgraph "è°ƒåº¦ç­–ç•¥ (IDispatcherService)"
            direction LR
            LlmTool("LlmToolDispatcher<br>(Function Call)")
            LlmJson("LlmJsonDispatcher<br>(JSON Mode)")
            Embedding("EmbeddingDispatcher<br>(æœªæ¥å®ç°)")
        end
        
        Analyzers("å„ç§Analyzer.cs<br>5. æ‰§è¡Œå…·ä½“å·¥å…·")

        Governor --> Factory
        Factory -- reads --> Settings
        Factory -->|"3. è¿”å›ä¸€ä¸ªå…·ä½“å®ç°"| LlmTool
        LlmTool -->|"4. è¿”å›å†³ç­–ç»“æœ"| Governor
        Governor --> Analyzers

        Factory -.-> LlmJson
        Factory -.-> Embedding
    end

    style LlmJson fill:#f9f,stroke:#333,stroke-width:2px,color:black
    style Embedding fill:#f9f,stroke:#333,stroke-width:2px,color:black
```

### ç»„ä»¶ç±»æ¯”ï¼šDispatcherService ä¸ ServiceContainer (Analogy: DispatcherService vs. ServiceContainer)

ä¸ºäº†æ›´æ·±åˆ»åœ°ç†è§£ `DispatcherService` åœ¨æˆ‘ä»¬æ¶æ„ä¸­çš„è§’è‰²ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¸é¡¹ç›®ä¸­å·²ç»å­˜åœ¨çš„ `ServiceContainer` è¿›è¡Œç±»æ¯”ã€‚ä¸€è¨€ä»¥è”½ä¹‹ï¼š**`DispatcherService` å°±æ˜¯ `ServiceContainer` çš„â€œAIè¯­ä¹‰ç‰ˆæœ¬â€**ã€‚

å®ƒä»¬éƒ½è´Ÿè´£â€œæä¾›æœåŠ¡â€ï¼Œä½†å…¶èŒè´£ã€é©±åŠ¨åŠ›å’Œå·¥ä½œå±‚é¢å®Œå…¨ä¸åŒã€‚

| ç‰¹æ€§ | `ServiceContainer` (ä¾èµ–æ³¨å…¥å®¹å™¨) | `AIDispatcherService` (AIè°ƒåº¦å™¨) |
| :--- | :--- | :--- |
| **æ ¸å¿ƒé—®é¢˜** | **"å¦‚ä½•è·å– (How to Get)?"** | **"åº”è¯¥ç”¨ä»€ä¹ˆ (What to Use)?"** |
| **å®ƒçš„èŒè´£** | æˆ‘éœ€è¦ä¸€ä¸ª `IHistoryService` çš„å®ä¾‹ï¼Œè¯·**ç»™æˆ‘ä¸€ä¸ª**ã€‚ | ç”¨æˆ·æƒ³çŸ¥é“æ®–æ°‘åœ°å¿ƒæƒ…ï¼Œè¯·**å‘Šè¯‰æˆ‘ç”¨å“ªä¸ªå·¥å…·**æ¥åˆ†æã€‚ |
| **é©±åŠ¨åŠ›** | **ç±»å‹ä¾èµ– (Type Dependency)** | **è¯­ä¹‰æ„å›¾ (Semantic Intent)** |
| **å·¥ä½œåŸç†** | åŸºäºä»£ç ä¸­é¢„å…ˆæ³¨å†Œçš„ç±»å‹æ˜ å°„ã€‚ (`Register<IHistoryService, HistoryService>()`) | åŸºäºLLMå¯¹è‡ªç„¶è¯­è¨€çš„ç†è§£ï¼Œæˆ–Embeddingçš„å‘é‡ç›¸ä¼¼åº¦è®¡ç®—ã€‚ |
| **å†³ç­–æ–¹å¼** | **é™æ€çš„ã€ç¼–è¯‘æ—¶çš„**ã€‚å½“ä»£ç éœ€è¦ä¸€ä¸ª`IHistoryService`æ—¶ï¼Œå®ƒæ€»æ˜¯è¿”å›ä¸€ä¸ª`HistoryService`å®ä¾‹ã€‚ | **åŠ¨æ€çš„ã€è¿è¡Œæ—¶çš„**ã€‚æ ¹æ®ç”¨æˆ·æ¯ä¸€å¥è¯çš„**å«ä¹‰**æ¥åšå†³ç­–ã€‚ |
| **ç®€å•ç±»æ¯”**| **åå‹¤å®˜/ä»“åº“ç®¡ç†å‘˜**ï¼šæŒ‰æ¸…å•ï¼ˆç±»å‹ï¼‰ç´¢è¦å·¥å…·ï¼Œä»–ä»ä»“åº“ï¼ˆå®¹å™¨ï¼‰é‡Œæ‹¿ç»™ä½ ã€‚ | **é¡¹ç›®ç»ç†/æŒ‡æŒ¥å®˜**ï¼šå‘Šè¯‰ä»–ç›®æ ‡ï¼ˆâ€œæˆ‘è¦åŠ å›ºå¢™â€ï¼‰ï¼Œä»–æ¥å†³å®šä½ åº”è¯¥ç”¨é”¤å­è¿˜æ˜¯ç”µé’»ã€‚ |

#### æœ€ç»ˆåä½œæµç¨‹ï¼šé¿å…é‡å¤é€ è½®å­ (Final Collaboration Workflow: Avoiding Reinventing the Wheel)

ä¸Šè¿°ç±»æ¯”æå‡ºäº†ä¸€ä¸ªé«˜å±‚è®¾æƒ³ï¼Œä½†è¦çœŸæ­£è½åœ°ï¼Œå¿…é¡»è§£å†³ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**å¦‚ä½•ä¼˜é›…åœ°å°†AIè¿”å›çš„å·¥å…·åç§°ï¼ˆ`string`ï¼‰ä¸C#ä¸–ç•Œä¸­çš„æœåŠ¡å®ä¾‹ï¼ˆ`object`ï¼‰è¿æ¥èµ·æ¥ï¼ŒåŒæ—¶å®Œå…¨å¤ç”¨ `ServiceContainer` çš„ä¾èµ–æ³¨å…¥èƒ½åŠ›ï¼Ÿ**

ç­”æ¡ˆæ˜¯ï¼š**å°† `ToolRegistryService` å‡çº§ä¸ºå…³é”®çš„â€œç¿»è¯‘å®˜/æ˜ å°„å™¨â€**ã€‚

æˆ‘ä»¬åœ¨æ³¨å†Œå·¥å…·æ—¶ï¼Œå°±å»ºç«‹èµ·â€œAIèƒ½ç†è§£çš„å·¥å…·åâ€åˆ°â€œC#èƒ½ç†è§£çš„æœåŠ¡ç±»å‹â€ä¹‹é—´çš„æ˜ å°„ã€‚è¿™ä½¿å¾— `Governor` çš„èŒè´£æå…¶çº¯ç²¹ï¼Œåªè´Ÿè´£åè°ƒï¼Œè€Œæ— éœ€å…³å¿ƒä»»ä½•æœåŠ¡çš„åˆ›å»ºç»†èŠ‚ã€‚

æœ€ç»ˆçš„åä½œæµç¨‹å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
    participant Governor as æ€»ç£ (Governor)
    participant Dispatcher as AIDispatcher (AIå¤§è„‘)
    participant Registry as ToolRegistry (ç¿»è¯‘å®˜)
    participant Container as ServiceContainer (åå‹¤å®˜)
    participant Analyzer as IColonyAnalyzer (å…·ä½“å·¥å…·)

    Governor->>Dispatcher: 1. "è¯¥ç”¨ä»€ä¹ˆå·¥å…·?" (What to use?)
    Dispatcher-->>Governor: 2. "ç”¨ 'analyze_colony_mood' å·¥å…·"

    Governor->>Registry: 3. "'analyze_colony_mood' å¯¹åº”ä»€ä¹ˆC#ç±»å‹?"
    Registry-->>Governor: 4. "æ˜¯ typeof(IColonyAnalyzer)"

    Governor->>Container: 5. "è¯·ç»™æˆ‘ä¸€ä¸ª IColonyAnalyzer å®ä¾‹" (How to get it?)
    Container-->>Governor: 6. "ç»™ä½ ï¼Œè¿™æ˜¯ä½ è¦çš„ Analyzer å®ä¾‹"

    Governor->>Analyzer: 7. "æ‰§è¡Œåˆ†æä»»åŠ¡"
    Analyzer-->>Governor: 8. "åˆ†æå®Œæ¯•"
```

åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬å®Œç¾åœ°å®ç°äº†ï¼š
-   **å°Šé‡ä¾èµ–æ³¨å…¥**ï¼š`ServiceContainer` ä¾ç„¶æ˜¯åˆ›å»ºå’Œç®¡ç†æœåŠ¡å®ä¾‹çš„å”¯ä¸€æƒå¨ã€‚
-   **é¿å…é‡å¤é€ è½®å­**ï¼š`Governor` ä¸­ä¸å­˜åœ¨ä»»ä½• `if/else` æˆ– `switch` æ¥æ‰‹åŠ¨åˆ›å»ºæœåŠ¡ã€‚
-   **é«˜åº¦å¯æ‰©å±•**ï¼šæ·»åŠ æ–°å·¥å…·åªéœ€åœ¨ `ToolRegistry` å’Œ `ServiceContainer` ä¸­å„æ³¨å†Œä¸€è¡Œï¼Œæ— éœ€æ”¹åŠ¨æ ¸å¿ƒåè°ƒé€»è¾‘ã€‚

è¿™ä¸ªè®¾è®¡å°†åº•å±‚çš„**ä¾èµ–è§£æï¼ˆ`ServiceContainer`ï¼‰**å’Œé«˜å±‚çš„**æ„å›¾ç†è§£ï¼ˆ`DispatcherService`ï¼‰**æ¸…æ™°åœ°åˆ†ç¦»å¼€æ¥ï¼Œä½¿å¾—æˆ‘ä»¬çš„AIç³»ç»Ÿæ—¢å¥å£®åˆèªæ˜ã€‚

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’ (Next Actions)

æˆ‘ä»¬å°†æŒ‰ç…§ä¸Šè¿°æ¶æ„è®¾è®¡ï¼Œåˆ†æ­¥å®ç°è¯¥åŠŸèƒ½ã€‚

1.  **ã€å·²å®Œæˆã€‘** åˆ›å»º `IDispatcherService` æ¥å£å’Œ `ToolModels.cs` æ•°æ®æ¨¡å‹ã€‚
2.  **ã€å·²å®Œæˆã€‘** åˆ›å»º `ToolRegistryService` å¹¶å®ç°å·¥å…·æ³¨å†Œä¸ç±»å‹æ˜ å°„ã€‚
3.  **ã€å·²å®Œæˆã€‘** åˆ›å»º `LlmToolDispatcherService` å’Œ `LlmJsonDispatcherService`ã€‚
4.  **ã€å·²å®Œæˆã€‘** åˆ›å»º `DispatcherFactory`ã€‚
5.  **ã€å·²å®Œæˆã€‘** ä¿®æ”¹ `CoreSettings` å’Œ `CoreSettingsWindow` ä»¥æ·»åŠ è®¾ç½®é€‰é¡¹ã€‚
6.  **ã€å·²å®Œæˆã€‘** é‡æ„ `Governor.cs` ä»¥ä½¿ç”¨æ–°çš„è°ƒåº¦å™¨æ¶æ„ã€‚

**æ‰€æœ‰è®¡åˆ’ä»»åŠ¡å‡å·²å®Œæˆã€‚** 