# P10.5 实施计划：个性化服务重构与“个性窗体”

> **目标**：对现有服务进行重构，将与“个体性格”相关的服务进行整合，提高模块内聚性，并为玩家提供一个统一的管理入口。此计划作为 P10 与 P11 之间的插入式升级。

---

## 1. 背景与动机

在 P10 完成后，我们拥有了强大的历史、总结与提示组装能力。但实践中发现，`固定提示词`与`人物传记`本质上是**围绕“个体”的静态或半静态性格数据**，将其与动态、流动的“历史事件”耦合在同一个服务和 UI 中，职责不够清晰。

P11 的“舞台服务”将更加依赖于对个体性格的深刻理解来驱动互动。因此，有必要在此之前，将所有定义“我是谁”的服务进行整合，形成一个独立的、高内聚的**个性化模块 (Personalization Module)**。

---

## 2. 核心设计变更

### 2.1. 服务层重构：抽离与整合

1.  **抽离 `固定提示词服务` 与 `个人传记服务`**
    *   **动作**: 将 `FixedPromptService` 和 `BiographyService` 的实现逻辑，从 `HistoryService` 及其相关实现中完全剥离。
    *   **目标**: `HistoryService` 将只负责处理**事件驱动的、动态的**历史记录、总结与前情提要。`固定提示词`与`个人传记`不再是历史的一部分。
    *   **索引变更**: 这两个服务未来的数据存储和检索，将**严格且仅**使用小人的唯一 ID (如 `pawn:<loadId>`) 作为主键，不再与 `convKey` 或其他复合 ID 关联。

2.  **新增 `个人观点与意识形态服务` (`IPersonalBeliefsAndIdeologyService`)**
    *   **定位**: 这是一个全新的服务，用于定义和存储小人更深层次的、不易改变的内在特质。
    *   **内容示例**:
        *   世界观 (e.g., "世界是残酷的，必须不择手段才能生存")
        *   价值观 (e.g., "集体荣誉高于一切")
        *   行为准则 (e.g., "我绝不背叛朋友")
        *   性格特质的自然语言描述 (e.g., "一个多疑、悲观但内心善良的人")
    *   **数据来源**: 可由玩家手动编辑，或在未来由 AI 根据小人的行为和历史自动提炼生成。
    *   **索引**: 同样，**严格且仅**使用小人的唯一 ID 作为主键。

### 2.2. UI 层重构：引入“个性窗体”

1.  **废弃旧入口**: 移除 `历史管理窗体` 中与 `固定提示词` 和 `人物传记` 相关的 Tab 页和编辑功能。

2.  **创建新的“个性窗体” (`MainTabWindow_Personality`)**
    *   **定位**: 这是一个全新的主标签页窗口，作为管理所有小人“内在个性”的统一入口。
    *   **交互**:
        *   窗口左侧是一个可搜索的小人列表，玩家选择一个目标小人。
        *   窗口右侧是针对该小人的个性化设置，包含三个清晰的 Tab 页：
            *   **Tab 1: 固定提示词**: 用于为该小人设置在特定情境下（如战斗、闲聊）的强制性行为或口头禅。
            *   **Tab 2: 个人传记**: 用于编辑该小人的背景故事、关键经历等长文本内容。
            *   **Tab 3: 观点与意识形态**: 用于编辑该小人的核心世界观、价值观等。

### 2.3. 提示组装流程变更

1.  **`IPromptAssemblyService` 依赖变更**:
    *   `IPromptAssemblyService` 将不再从 `IHistoryService` 获取固定提示和传记。
    *   它将新增对 `IFixedPromptService`, `IBiographyService`, 和 `IPersonalBeliefsAndIdeologyService` 的依赖。

2.  **`IPersonaService` 调用流程**:
    *   当 `PersonaService` 为某个小人组装 System Prompt 时，它会调用 `IPromptAssemblyService`。
    *   `IPromptAssemblyService` 会按以下顺序（或其他更优顺序）组合提示词：
        1.  调用 `IPersonalBeliefsAndIdeologyService` 获取核心观点。
        2.  调用 `IBiographyService` 获取个人传记。
        3.  调用 `IFixedPromptService` 获取场景相关的固定提示。
        4.  (原流程) 调用 `IHistoryService` 获取历史摘要、前情提要等动态上下文。
    *   这意味着，小人的**内在性格**将作为提示词最底层的、最稳定的部分被注入。

---

## 3. 实施要点与 Gate

*   **M1: 服务层重构**
    *   完成 `FixedPromptService` 和 `BiographyService` 的代码迁移。
    *   创建 `IPersonalBeliefsAndIdeologyService` 及其骨架实现。
    *   调整 `IPromptAssemblyService` 的依赖和实现。
    *   **Gate**: 单元测试通过，确保 `IPromptAssemblyService` 能正确从新服务中拉取并组装提示。

*   **M2: UI 层实现**
    *   创建 `MainTabWindow_Personality` 窗口及三个子 Tab 页。
    *   实现与三个新服务的后台数据绑定（读取、写入）。
    *   移除历史窗体的旧功能。
    *   **Gate**: 在游戏中可以打开“个性窗体”，能为任意小人编辑并成功保存三类个性化数据。Debug Panel 中可以预览到包含新数据的完整提示词。

*   **M3: 持久化与兼容性**
    *   确保三个新服务的数据能正确地随游戏存档保存和加载。
    *   考虑旧存档的迁移方案（例如，在首次加载时，将旧历史服务中的相关数据迁移到新服务中）。
    *   **Gate**: 存档、读档后，所有在“个性窗体”中设置的数据保持不变。

---

## 4. 总结

P10.5 计划通过一次专注的重构，将“我是谁”（静态个性）与“我经历了什么”（动态历史）清晰地分离开来。这不仅优化了系统架构，也为玩家提供了更直观、更聚焦的管理工具，更为 P11 中更复杂的、基于性格的 AI 互动打下了坚实的基础。
